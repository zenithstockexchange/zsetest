<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Zenith Stock Exchange — Multi-User</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
/* Basic reset + fonts */
:root{
--bg1: #f8fafc;
--card: #ffffff;
--muted: #64748b;
--green: #16a34a;
--red: #ef4444;
--accent: #0ea5e9;
--page-bg: linear-gradient(180deg,#f1f5f9 0%,#ffffff 100%);
}
html,body{height:100%;margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;}
body{
background: var(--page-bg);
padding:20px;
color:#0f172a;
-webkit-font-smoothing:antialiased;
-moz-osx-font-smoothing:grayscale;
}

/* Container */
.container{max-width:1200px;margin:0 auto;}

header{display:flex;justify-content:space-between;align-items:center;gap:20px;margin-bottom:18px}
h1{font-size:28px;margin:0}
.meta{display:flex;gap:16px;align-items:center}

/* Controls */
select, button, input[type="number"], input[type="text"], input[type="password"]{padding:8px 10px;border:1px solid #e2e8f0;border-radius:8px;font-size:14px}
button.primary{background:#0f172a;color:white;border:none;cursor:pointer}
button.ghost{background:transparent;border:1px solid #cbd5e1;cursor:pointer}
button.danger{background:#ef4444;color:white;border:none;cursor:pointer}
button.success{background:#16a34a;color:white;border:none;cursor:pointer}

main{display:grid;grid-template-columns:1fr 320px;gap:18px}

/* Left area with cards */
.cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:14px}
.card{background:var(--card);border-radius:16px;padding:14px;box-shadow:0 6px 18px rgba(15,23,42,0.06);cursor:pointer;transition:transform .18s,box-shadow .18s}
.card:hover{transform:translateY(-4px);box-shadow:0 10px 30px rgba(15,23,42,0.08)}
.row{display:flex;align-items:center;justify-content:space-between}
.symbol{font-weight:700;font-size:16px}
.name{color:var(--muted);font-size:13px;margin-left:8px}
.price{font-size:20px;margin-top:8px;font-weight:700}
.small{font-size:12px;color:var(--muted)}
.spark{width:160px;height:60px}

/* expanded details */
.expanded{margin-top:12px;border-top:1px dashed #eef2f7;padding-top:12px}
.btn-buy{background:#16a34a;color:white;border:none;padding:8px 10px;border-radius:8px;cursor:pointer}
.btn-buy:hover{opacity:.95}
.btn-buy-secondary{background:#059669;color:white;border:none;padding:8px 10px;border-radius:8px;cursor:pointer}
.qty{width:90px}

/* Right column */
aside .panel{background:var(--card);padding:14px;border-radius:16px;box-shadow:0 6px 18px rgba(15,23,42,0.06)}
.invest-list{margin-top:10px}
.invest-item{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid #f1f5f9}
.muted{color:var(--muted)}

/* Login Screen */
.login-screen{
display:flex;
justify-content:center;
align-items:center;
min-height:80vh;
}
.login-box{
background:var(--card);
padding:32px;
border-radius:16px;
box-shadow:0 10px 40px rgba(15,23,42,0.1);
width:100%;
max-width:400px;
}
.login-box h2{margin:0 0 20px 0;text-align:center}
.form-group{margin-bottom:16px}
.form-group label{display:block;margin-bottom:6px;font-weight:600;font-size:14px}
.form-group input{width:100%;box-sizing:border-box}
.form-group button{width:100%;padding:12px;font-size:16px}

/* Admin Panel */
.admin-panel{background:var(--card);padding:20px;border-radius:16px;box-shadow:0 6px 18px rgba(15,23,42,0.06);margin-bottom:20px}
.admin-section{margin-bottom:24px}
.admin-section h3{margin:0 0 12px 0;font-size:18px}
.participant-list, .stock-list{display:flex;flex-direction:column;gap:8px}
.participant-item, .stock-item{
background:#f8fafc;
padding:12px;
border-radius:8px;
display:flex;
justify-content:space-between;
align-items:center;
}
.participant-actions, .stock-actions{display:flex;gap:6px}
.market-status{
display:inline-block;
padding:6px 12px;
border-radius:6px;
font-weight:600;
font-size:14px;
}
.market-status.running{background:#dcfce7;color:#16a34a}
.market-status.stopped{background:#fee2e2;color:#ef4444}

.modal{
display:none;
position:fixed;
top:0;
left:0;
width:100%;
height:100%;
background:rgba(0,0,0,0.5);
justify-content:center;
align-items:center;
z-index:1000;
}
.modal.active{display:flex}
.modal-content{
background:var(--card);
padding:24px;
border-radius:16px;
width:90%;
max-width:500px;
max-height:80vh;
overflow-y:auto;
}
.modal-content h3{margin:0 0 16px 0}

footer{text-align:center;margin-top:20px;color:#94a3b8;font-size:13px}

/* small responsive */
@media (max-width:880px){
main{grid-template-columns:1fr}
header{flex-direction:column;align-items:flex-start;gap:8px}
}
</style>
</head>
<body>
<div class="container">

<!-- Login Screen -->
<div id="loginScreen" class="login-screen">
<div class="login-box">
<h2>Zenith Stock Exchange</h2>
<div class="form-group">
<label>User ID</label>
<input type="text" id="loginUsername" placeholder="Enter your ID" />
</div>
<div class="form-group">
<label>Password</label>
<input type="password" id="loginPassword" placeholder="Enter password" />
</div>
<div class="form-group">
<button class="primary" id="loginBtn">Login</button>
</div>
<div id="loginError" style="color:var(--red);text-align:center;margin-top:10px;display:none"></div>
</div>
</div>

<!-- Main App (hidden until login) -->
<div id="mainApp" style="display:none">

<!-- Admin Panel (only for admin) -->
<div id="adminPanel" style="display:none">
<div class="admin-panel">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
<h2 style="margin:0">Admin Dashboard</h2>
<button class="ghost" id="logoutBtn">Logout</button>
</div>

<!-- Market Control -->
<div class="admin-section">
<h3>Market Control</h3>
<div style="display:flex;gap:12px;align-items:center">
<span class="market-status" id="marketStatus">Running</span>
<button class="success" id="startMarketBtn">Start Market</button>
<button class="danger" id="stopMarketBtn">Stop Market</button>
</div>
</div>

<!-- Participants Management -->
<div class="admin-section">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
<h3 style="margin:0">Participants</h3>
<button class="primary" id="addParticipantBtn">Add Participant</button>
</div>
<div class="participant-list" id="participantList"></div>
</div>

<!-- Stocks Management -->
<div class="admin-section">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
<h3 style="margin:0">Stocks Configuration</h3>
<button class="primary" id="addStockBtn">Add Stock</button>
</div>
<div class="stock-list" id="stockList"></div>
</div>
</div>
</div>

<!-- Participant View -->
<div id="participantView" style="display:none">
<header>
<div>
<h1>Zenith Stock Exchange</h1>
<div class="small muted">Fake market — demo only</div>
</div>

<div class="meta">
<div style="text-align:right">
<div class="small muted">User</div>
<div id="currentUser" style="font-weight:700"></div>
</div>

<div style="text-align:right;margin-left:8px">
<div class="small muted">Market cap (sim)</div>
<div id="marketCap" style="font-weight:700">₹0</div>
</div>

<div style="text-align:right;margin-left:8px">
<div class="small muted">Cash</div>
<div id="cash" style="font-weight:700">₹0</div>
</div>

<label class="small muted" style="margin-left:10px">Update</label>
<select id="intervalSelect" title="Update interval">
<option value="10000">10 Seconds</option>
</select>

<button class="ghost" id="logoutBtnParticipant" style="margin-left:6px">Logout</button>
</div>
</header>

<main>
<section>
<div class="cards" id="cardsContainer"></div>

<!-- Expanded chart area -->
<div id="expandedArea" style="display:none;margin-top:16px" class="card">
<div class="row" style="align-items:flex-start">
<div>
<div style="display:flex;align-items:center">
<div id="expandedSymbol" class="symbol"></div>
<div id="expandedName" class="name"></div>
</div>
<div id="expandedPrice" class="price"></div>
<div id="expandedChange" class="small muted" style="margin-top:4px"></div>
</div>

<div style="width:360px">
<canvas id="expandedChart" width="360" height="160"></canvas>
</div>
</div>

<div class="expanded">
<div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
<div>
<label class="small muted">Buy quantity</label><br/>
<input id="buyQty" class="qty" type="number" min="1" value="10" />
</div>

<div>
<label class="small muted">Sell quantity</label><br/>
<input id="sellQty" class="qty" type="number" min="1" value="10" />
</div>

<div style="display:flex;gap:8px;align-items:center">
<button id="buyBtn" class="btn-buy">Buy</button>
<button id="sellBtn" class="btn-buy-secondary">Sell</button>
</div>

<div style="margin-left:auto" class="muted small">
<span id="expandedVol">Vol 0</span>
</div>
</div>
</div>
</div>
</section>

<aside>
<div class="panel">
<h3 style="margin:0 0 6px 0">My Investments</h3>

<div style="margin-top:10px">
<div class="small muted">Portfolio Value</div>
<div id="portfolioValue" style="font-weight:700">₹0</div>
</div>

<div class="invest-list" id="investList"></div>
</div>
</aside>
</main>

<footer>
Built for demo — not financial advice.
</footer>
</div>

</div>

<!-- Modals -->
<div id="participantModal" class="modal">
<div class="modal-content">
<h3 id="participantModalTitle">Add Participant</h3>
<div class="form-group">
<label>User ID</label>
<input type="text" id="modalParticipantId" />
</div>
<div class="form-group">
<label>Password</label>
<input type="password" id="modalParticipantPassword" />
</div>
<div class="form-group">
<label>Starting Balance (₹)</label>
<input type="number" id="modalParticipantBalance" value="1000000" />
</div>
<div style="display:flex;gap:8px;justify-content:flex-end">
<button class="ghost" id="cancelParticipantBtn">Cancel</button>
<button class="primary" id="saveParticipantBtn">Save</button>
</div>
</div>
</div>

<div id="stockModal" class="modal">
<div class="modal-content">
<h3 id="stockModalTitle">Add Stock</h3>
<div class="form-group">
<label>Symbol</label>
<input type="text" id="modalStockSymbol" />
</div>
<div class="form-group">
<label>Company Name</label>
<input type="text" id="modalStockName" />
</div>
<div class="form-group">
<label>Starting Price (₹)</label>
<input type="number" id="modalStockPrice" value="100" step="0.01" />
</div>
<div style="display:flex;gap:8px;justify-content:flex-end">
<button class="ghost" id="cancelStockBtn">Cancel</button>
<button class="primary" id="saveStockBtn">Save</button>
</div>
</div>
</div>

</div>

<script>
/* -------------------------
Supabase Configuration
------------------------- */

// REPLACE THESE WITH YOUR SUPABASE CREDENTIALS
const SUPABASE_URL = 'https://doizdbmqzwmzaqwnotej.supabase.co';
const SUPABASE_ANON_KEY = 'sb_publishable_4hZf2fDPmK1voXA_oJZaEQ_6yn27sCc';

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* -------------------------
System Configuration & Auth
------------------------- */

const ADMIN_DEFAULT = {username: "ZSE", password: "ZAHEER", role: "admin"};

let systemState = {
marketRunning: true,
admin: ADMIN_DEFAULT,
participants: [],
stocks: [],
companies: [],
intervalMs: 5000,
running: true,
};

let currentUser = null;
let editingParticipantIndex = null;
let editingStockIndex = null;
let tickerHandle = null;  // ← ADD THIS HERE
let adminRefreshHandle = null;

function randBetween(min,max){ return Math.random()*(max-min)+min }
function formatINR(n){ return "Ƶ" + Number(n).toLocaleString('en-IN', {maximumFractionDigits:2, minimumFractionDigits:2}) }

/* -------------------------
Supabase Functions
------------------------- */

async function loadSystemState(){
try{
// Load system config
const { data: config, error: configError } = await supabase
.from('system_config')
.select('*')
.eq('id', 1)
.single();

if (!configError && config) {
systemState.marketRunning = config.market_running;
systemState.intervalMs = config.interval_ms;
}

// Load participants
const { data: participants, error: participantsError } = await supabase
.from('participants')
.select('*');

if (!participantsError && participants) {
systemState.participants = participants.map(p => ({
username: p.username,
password: p.password,
cash: Number(p.cash),
investments: p.investments || []
}));
}

// Load stocks
const { data: stocks, error: stocksError } = await supabase
.from('stocks')
.select('*');

if (!stocksError && stocks) {
systemState.stocks = stocks.map(s => ({
symbol: s.symbol,
name: s.name,
price: Number(s.price)
}));
}

// Load admin
const { data: admin, error: adminError } = await supabase
.from('admin_users')
.select('*')
.eq('username', 'admin')
.single();

if (!adminError && admin) {
systemState.admin = {
username: admin.username,
password: admin.password,
role: 'admin'
};
}

await initializeCompanies();
}catch(e){ 
console.warn("load failed", e);
}
}

async function saveSystemConfig(){
await supabase
.from('system_config')
.update({ 
market_running: systemState.marketRunning,
interval_ms: systemState.intervalMs 
})
.eq('id', 1);
}

async function saveParticipant(participant){
const { data, error } = await supabase
.from('participants')
.upsert({
username: participant.username,
password: participant.password,
cash: participant.cash,
investments: participant.investments
}, { onConflict: 'username' })
.select();

return !error;
}

async function deleteParticipantFromDB(username){
await supabase
.from('participants')
.delete()
.eq('username', username);
}

async function saveStockToDB(stock){
const { data, error } = await supabase
.from('stocks')
.upsert({
symbol: stock.symbol,
name: stock.name,
price: stock.price,
current_price: stock.price  // ← Add this line
}, { onConflict: 'symbol' })
.select();

return !error;
}
  
async function deleteStockFromDB(symbol){
await supabase
.from('stocks')
.delete()
.eq('symbol', symbol);
}

async function updateStockPrices() {
// Update prices in systemState.companies (simulated market movement)
systemState.companies = systemState.companies.map(c => {
const volatility = 0.04;
const pct = (Math.random() * 2 - 1) * volatility;
const newPrice = Math.max(0.01, c.price * (1 + pct));
const change = newPrice - c.price;
const newHistory = [...c.history.slice(1), Number(newPrice.toFixed(2))];
const newVolume = c.volume + Math.floor(randBetween(100, 20000));
return {
...c,
price: Number(newPrice.toFixed(2)),
change: Number(change.toFixed(2)),
history: newHistory,
volume: newVolume
};
});

// Save ALL updated prices to Supabase
const updates = systemState.companies.map(c => ({
symbol: c.symbol,
current_price: c.price
}));

// Batch update to Supabase
for (const update of updates) {
await supabase
.from('stocks')
.update({ current_price: update.current_price })
.eq('symbol', update.symbol);
}
}

async function fetchCurrentPrices() {
// Fetch current prices from Supabase
const { data: stocks, error } = await supabase
.from('stocks')
.select('symbol, current_price');

if (!error && stocks) {
// Update local companies with Supabase prices
stocks.forEach(stock => {
const company = systemState.companies.find(c => c.symbol === stock.symbol);
if (company && stock.current_price) {
const oldPrice = company.price;
const newPrice = Number(stock.current_price);
company.price = newPrice;
company.change = newPrice - oldPrice;
// Update history
company.history = [...company.history.slice(1), newPrice];
}
});
}
}



async function initializeCompanies(){
systemState.companies = systemState.stocks.map(s => ({
...s,
change: 0,
history: Array.from({length:12}, () => s.current_price || s.price),
volume: Math.floor(randBetween(1000,50000))
}));

// Fetch current prices from Supabase
await fetchCurrentPrices();
}

/* -------------------------
Authentication
------------------------- */

async function login(username, password){
// Check admin
if(username === systemState.admin.username && password === systemState.admin.password){
currentUser = {username, role: "admin"};
return true;
}
// Check participants
const participant = systemState.participants.find(p => p.username === username && p.password === password);
if(participant){
if(!systemState.marketRunning){
return "market_stopped";
}
currentUser = {username, role: "participant", data: participant};
return true;
}
return false;
}

function logout(){
currentUser = null;
stopAdminRefresh();
showLoginScreen();
}

/* -------------------------
UI Navigation
------------------------- */

function showLoginScreen(){
document.getElementById('loginScreen').style.display = 'flex';
document.getElementById('mainApp').style.display = 'none';
document.getElementById('loginUsername').value = '';
document.getElementById('loginPassword').value = '';
document.getElementById('loginError').style.display = 'none';
stopTicker();
}

function showMainApp(){
document.getElementById('loginScreen').style.display = 'none';
document.getElementById('mainApp').style.display = 'block';
if(currentUser.role === 'admin'){
showAdminView();
} else {
showParticipantView();
}
}

function showAdminView(){
document.getElementById('adminPanel').style.display = 'block';
document.getElementById('participantView').style.display = 'none';
renderAdminDashboard();
startAdminRefresh();
}

function showParticipantView(){
document.getElementById('adminPanel').style.display = 'none';
document.getElementById('participantView').style.display = 'block';
document.getElementById('currentUser').textContent = currentUser.username;
renderParticipantView();
startTicker();
}

/* -------------------------
Admin Auto-Refresh
------------------------- */



async function refreshAdminData(){
if(currentUser && currentUser.role === 'admin'){
// Fetch latest data from Supabase
const { data: participants, error: participantsError } = await supabase
.from('participants')
.select('*');

if (!participantsError && participants) {
systemState.participants = participants.map(p => ({
username: p.username,
password: p.password,
cash: Number(p.cash),
investments: p.investments || []
}));
}

// Re-render with fresh data
renderAdminDashboard();
}
}

function startAdminRefresh(){
stopAdminRefresh();
adminRefreshHandle = setInterval(()=> {
refreshAdminData();
}, 3000); // Refresh every 3 seconds
}

function stopAdminRefresh(){
if(adminRefreshHandle) { 
clearInterval(adminRefreshHandle); 
adminRefreshHandle = null; 
}
}
/* -------------------------
Admin Dashboard
------------------------- */

function renderAdminDashboard(){
// Market status
const statusEl = document.getElementById('marketStatus');
if(systemState.marketRunning){
statusEl.textContent = 'Running';
statusEl.className = 'market-status running';
} else {
statusEl.textContent = 'Stopped';
statusEl.className = 'market-status stopped';
}

// Participants with detailed portfolio - SORTED BY PORTFOLIO VALUE
const participantList = document.getElementById('participantList');
participantList.innerHTML = '';
if(systemState.participants.length === 0){
participantList.innerHTML = '<div class="muted small">No participants yet.</div>';
} else {
// Calculate portfolio values and sort
const participantsWithPortfolio = systemState.participants.map((p, idx) => {
let holdingsValue = 0;
if(p.investments && p.investments.length > 0) {
p.investments.forEach(inv => {
const currentStock = systemState.companies.find(c => c.symbol === inv.symbol);
const currentPrice = currentStock ? currentStock.price : inv.buyPrice;
holdingsValue += currentPrice * inv.qty;
});
}
const totalPortfolio = Number(p.cash) + holdingsValue;
return { participant: p, originalIndex: idx, totalPortfolio, holdingsValue };
});

// Sort by portfolio value in descending order (highest first)
participantsWithPortfolio.sort((a, b) => b.totalPortfolio - a.totalPortfolio);

// Render sorted participants
participantsWithPortfolio.forEach(({ participant: p, originalIndex: idx, totalPortfolio, holdingsValue }) => {
let holdingsHTML = '';

if(p.investments && p.investments.length > 0) {
p.investments.forEach(inv => {
const currentStock = systemState.companies.find(c => c.symbol === inv.symbol);
const currentPrice = currentStock ? currentStock.price : inv.buyPrice;
const investmentValue = currentPrice * inv.qty;
const profitLoss = (currentPrice - inv.buyPrice) * inv.qty;
const profitLossPercent = ((currentPrice - inv.buyPrice) / inv.buyPrice) * 100;

const plColor = profitLoss >= 0 ? '#16a34a' : '#ef4444';
holdingsHTML += `
<div style="display:flex;justify-content:space-between;padding:4px 0;font-size:12px;border-bottom:1px solid #f1f5f9">
<div>
<strong>${inv.symbol}</strong>: ${inv.qty} shares @ ${formatINR(inv.buyPrice)}
</div>
<div style="text-align:right">
<div>Value: ${formatINR(investmentValue)}</div>
<div style="color:${plColor};font-weight:600">
${profitLoss >= 0 ? '+' : ''}${formatINR(profitLoss)} (${profitLoss >= 0 ? '+' : ''}${profitLossPercent.toFixed(2)}%)
</div>
</div>
</div>
`;
});
} else {
holdingsHTML = '<div class="small muted" style="padding:4px 0">No holdings</div>';
}

const totalInvested = p.investments.reduce((acc, inv) => acc + (inv.buyPrice * inv.qty), 0);
const overallPL = holdingsValue - totalInvested;
const overallPLColor = overallPL >= 0 ? '#16a34a' : '#ef4444';

const div = document.createElement('div');
div.className = 'participant-item';
div.style.flexDirection = 'column';
div.style.alignItems = 'stretch';
div.innerHTML = `
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
<div>
<div style="font-weight:600;font-size:16px">${p.username}</div>
<div class="small muted">Cash: ${formatINR(p.cash)} | Holdings: ${p.investments.length} stocks</div>
</div>
<div class="participant-actions">
<button class="ghost" onclick="editParticipant(${idx})">Edit</button>
<button class="danger" onclick="deleteParticipant(${idx})">Delete</button>
</div>
</div>
<div style="background:#f8fafc;padding:10px;border-radius:8px;border:1px solid #e2e8f0">
<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:8px">
<div>
<div class="small muted">Total Portfolio</div>
<div style="font-weight:700;font-size:16px">${formatINR(totalPortfolio)}</div>
</div>
<div>
<div class="small muted">Holdings Value</div>
<div style="font-weight:700;font-size:16px">${formatINR(holdingsValue)}</div>
</div>
<div>
<div class="small muted">Overall P/L</div>
<div style="font-weight:700;font-size:16px;color:${overallPLColor}">
${overallPL >= 0 ? '+' : ''}${formatINR(overallPL)}
</div>
</div>
</div>
${p.investments.length > 0 ? `
<div style="margin-top:8px">
<div class="small muted" style="margin-bottom:4px;font-weight:600">Investment Details:</div>
${holdingsHTML}
</div>
` : holdingsHTML}
</div>
`;
participantList.appendChild(div);
});
}

// Stocks with current prices and changes
const stockList = document.getElementById('stockList');
stockList.innerHTML = '';
systemState.stocks.forEach((s, idx) => {
// Find current live price
const liveStock = systemState.companies.find(c => c.symbol === s.symbol);
const currentPrice = liveStock ? liveStock.price : s.price;
const priceChange = currentPrice - s.price;
const priceChangePercent = ((currentPrice - s.price) / s.price) * 100;
const changeColor = priceChange >= 0 ? '#16a34a' : '#ef4444';

// Calculate total shares held by all participants
let totalShares = 0;
let totalInvested = 0;
systemState.participants.forEach(p => {
p.investments.forEach(inv => {
if(inv.symbol === s.symbol) {
totalShares += inv.qty;
totalInvested += inv.buyPrice * inv.qty;
}
});
});

const currentValue = currentPrice * totalShares;
const marketPL = currentValue - totalInvested;

const div = document.createElement('div');
div.className = 'stock-item';
div.style.flexDirection = 'column';
div.style.alignItems = 'stretch';
div.innerHTML = `
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
<div>
<div style="font-weight:600;font-size:16px">${s.symbol} - ${s.name}</div>
<div class="small muted">Starting Price: ${formatINR(s.price)}</div>
</div>
<div class="stock-actions">
<button class="ghost" onclick="editStock(${idx})">Edit</button>
<button class="danger" onclick="deleteStock(${idx})">Delete</button>
</div>
</div>
<div style="background:#f8fafc;padding:10px;border-radius:8px;border:1px solid #e2e8f0">
<div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:12px">
<div>
<div class="small muted">Current Price</div>
<div style="font-weight:700;font-size:16px">${formatINR(currentPrice)}</div>
</div>
<div>
<div class="small muted">Price Change</div>
<div style="font-weight:700;font-size:14px;color:${changeColor}">
${priceChange >= 0 ? '+' : ''}${formatINR(priceChange)}
<div class="small" style="color:${changeColor}">(${priceChange >= 0 ? '+' : ''}${priceChangePercent.toFixed(2)}%)</div>
</div>
</div>
<div>
<div class="small muted">Shares Held</div>
<div style="font-weight:700;font-size:16px">${totalShares}</div>
<div class="small muted">by participants</div>
</div>
<div>
<div class="small muted">Market P/L</div>
<div style="font-weight:700;font-size:14px;color:${marketPL >= 0 ? '#16a34a' : '#ef4444'}">
${marketPL >= 0 ? '+' : ''}${formatINR(marketPL)}
</div>
<div class="small muted">Total: ${formatINR(currentValue)}</div>
</div>
</div>
</div>
`;
stockList.appendChild(div);
});
}

async function startMarket(){
systemState.marketRunning = true;
await saveSystemConfig();
renderAdminDashboard();
alert('Market started! Participants can now login and trade.');
}

async function stopMarket(){
systemState.marketRunning = false;
await saveSystemConfig();
renderAdminDashboard();
alert('Market stopped! Participants cannot login or trade.');
}

/* -------------------------
Participant Management
------------------------- */

function addParticipant(){
editingParticipantIndex = null;
document.getElementById('participantModalTitle').textContent = 'Add Participant';
document.getElementById('modalParticipantId').value = '';
document.getElementById('modalParticipantPassword').value = '';
document.getElementById('modalParticipantBalance').value = '1000000';
document.getElementById('participantModal').classList.add('active');
}

function editParticipant(index){
editingParticipantIndex = index;
const p = systemState.participants[index];
document.getElementById('participantModalTitle').textContent = 'Edit Participant';
document.getElementById('modalParticipantId').value = p.username;
document.getElementById('modalParticipantPassword').value = p.password;
document.getElementById('modalParticipantBalance').value = p.cash;
document.getElementById('participantModal').classList.add('active');
}

async function saveParticipantHandler(){
const username = document.getElementById('modalParticipantId').value.trim();
const password = document.getElementById('modalParticipantPassword').value;
const cash = Number(document.getElementById('modalParticipantBalance').value);

if(!username || !password){
alert('Username and password are required');
return;
}

if(username === 'admin'){
alert('Cannot use "admin" as participant username');
return;
}

// Check duplicate username (except when editing same user)
const duplicate = systemState.participants.find((p, idx) => 
p.username === username && idx !== editingParticipantIndex
);
if(duplicate){
alert('Username already exists');
return;
}

const participant = {
username,
password,
cash,
investments: editingParticipantIndex !== null ? systemState.participants[editingParticipantIndex].investments : []
};

const success = await saveParticipant(participant);
if(success){
if(editingParticipantIndex !== null){
systemState.participants[editingParticipantIndex] = participant;
} else {
systemState.participants.push(participant);
}
document.getElementById('participantModal').classList.remove('active');
renderAdminDashboard();
} else {
alert('Failed to save participant');
}
}

async function deleteParticipant(index){
if(!confirm("Delete participant " + systemState.participants[index].username + "?")) return;
const username = systemState.participants[index].username;
await deleteParticipantFromDB(username);
systemState.participants.splice(index, 1);
renderAdminDashboard();
}

/* -------------------------
Stock Management
------------------------- */

function addStock(){
editingStockIndex = null;
document.getElementById('stockModalTitle').textContent = 'Add Stock';
document.getElementById('modalStockSymbol').value = '';
document.getElementById('modalStockName').value = '';
document.getElementById('modalStockPrice').value = '100';
document.getElementById('stockModal').classList.add('active');
}

function editStock(index){
editingStockIndex = index;
const s = systemState.stocks[index];
document.getElementById('stockModalTitle').textContent = 'Edit Stock';
document.getElementById('modalStockSymbol').value = s.symbol;
document.getElementById('modalStockName').value = s.name;
document.getElementById('modalStockPrice').value = s.price;
document.getElementById('stockModal').classList.add('active');
}

async function saveStockHandler(){
const symbol = document.getElementById('modalStockSymbol').value.trim().toUpperCase();
const name = document.getElementById('modalStockName').value.trim();
const price = Number(document.getElementById('modalStockPrice').value);

if(!symbol || !name || price <= 0){
alert('All fields are required and price must be positive');
return;
}

// Check duplicate symbol (except when editing same stock)
const duplicate = systemState.stocks.find((s, idx) => 
s.symbol === symbol && idx !== editingStockIndex
);
if(duplicate){
alert('Stock symbol already exists');
return;
}

const stock = {symbol, name, price};
const success = await saveStockToDB(stock);

if(success){
if(editingStockIndex !== null){
systemState.stocks[editingStockIndex] = stock;
} else {
systemState.stocks.push(stock);
}
initializeCompanies();
document.getElementById('stockModal').classList.remove('active');
renderAdminDashboard();
} else {
alert('Failed to save stock');
}
}

async function deleteStock(index){
if(!confirm("Delete stock " + systemState.stocks[index].symbol + "?")) return;
const symbol = systemState.stocks[index].symbol;
await deleteStockFromDB(symbol);
systemState.stocks.splice(index, 1);
initializeCompanies();
renderAdminDashboard();
}

/* -------------------------
Participant Trading View
------------------------- */

const cardsContainer = document.getElementById("cardsContainer");
const marketCapEl = document.getElementById("marketCap");
const cashEl = document.getElementById("cash");
const portfolioEl = document.getElementById("portfolioValue");
const investListEl = document.getElementById("investList");
const expandedArea = document.getElementById("expandedArea");
const expandedSymbol = document.getElementById("expandedSymbol");
const expandedName = document.getElementById("expandedName");
const expandedPrice = document.getElementById("expandedPrice");
const expandedChange = document.getElementById("expandedChange");
const expandedVol = document.getElementById("expandedVol");
const buyQtyInput = document.getElementById("buyQty");
const sellQtyInput = document.getElementById("sellQty");
const buyBtn = document.getElementById("buyBtn");
const sellBtn = document.getElementById("sellBtn");
const intervalSelect = document.getElementById("intervalSelect");

let expandedSymbolSelected = null;
let expandedChart = null;

function calcMarketCap(){
return systemState.companies.reduce((acc,c)=> acc + c.price * (1000000 + (c.symbol.charCodeAt(0)%5)*100000), 0);
}

function renderHeader(){
marketCapEl.textContent = formatINR(calcMarketCap()/1e6) + "M";
cashEl.textContent = formatINR(currentUser.data.cash);
}

function renderCards(){
cardsContainer.innerHTML = "";
systemState.companies.forEach((c, idx) => {
const div = document.createElement("div");
div.className = "card";
div.dataset.symbol = c.symbol;

const prev = c.history[c.history.length-2] ?? c.price;
const pct = prev ? ((c.price - prev)/ (prev) * 100) : 0;

div.innerHTML = `
<div class="row">
<div style="display:flex;align-items:center">
<div class="symbol">${c.symbol}</div>
<div class="name">${c.name}</div>
</div>
<div class="small muted">Vol ${c.volume.toLocaleString()}</div>
</div>

<div class="price">${formatINR(c.price)}</div>

<div style="display:flex;align-items:center;gap:8px;margin-top:6px">
<div class="${c.change >=0 ? 'small' : 'small'}" style="color:${c.change>=0? 'var(--green)':'var(--red)'};font-weight:600">
${c.change>=0?'+':''}${c.change.toFixed(2)} (${pct.toFixed(2)}%)
</div>
<div style="margin-left:auto" class="spark">
<canvas width="160" height="60" data-spark="${idx}"></canvas>
</div>
</div>
`;

div.addEventListener("click", ()=>{
if(expandedSymbolSelected === c.symbol) {
collapseExpanded();
} else {
openExpanded(c.symbol);
}
});

cardsContainer.appendChild(div);

const canvas = div.querySelector('canvas[data-spark]');
drawSpark(canvas, c.history);
});
}

function renderInvestments(){
investListEl.innerHTML = "";
if(currentUser.data.investments.length === 0){
investListEl.innerHTML = '<div class="muted small" style="margin-top:8px">No holdings yet.</div>';
portfolioEl.textContent = formatINR(currentUser.data.cash);
return;
}

let holdingsValue = 0;
currentUser.data.investments.forEach((inv, i) => {
const live = (systemState.companies.find(c=>c.symbol===inv.symbol)?.price) || inv.buyPrice;
const item = document.createElement("div");
item.className = "invest-item";

const left = document.createElement("div");
left.innerHTML = `<div style="font-weight:700">${inv.symbol} <span class="muted" style="font-weight:600">(${inv.qty} sh)</span></div>
<div class="muted small">bought @ ${formatINR(inv.buyPrice)}</div>`;

const right = document.createElement("div");
const pnlEl = document.createElement("div");
pnlEl.textContent = formatINR(live) + " ";
pnlEl.style.marginRight="8px";
const sellButton = document.createElement("button");
sellButton.className = "ghost";
sellButton.textContent = "Sell";
sellButton.addEventListener("click", ()=> {
sellInvestment(i);
});

right.appendChild(pnlEl);
right.appendChild(sellButton);

item.appendChild(left);
item.appendChild(right);

investListEl.appendChild(item);

holdingsValue += live * inv.qty;
});

const portfolioValue = currentUser.data.cash + holdingsValue;
portfolioEl.textContent = formatINR(portfolioValue);
}

function renderParticipantView(){
intervalSelect.value = String(systemState.intervalMs);
renderHeader();
renderCards();
renderInvestments();
}

/* -------------------------
Charts
------------------------- */

function drawSpark(canvas, history){
const ctx = canvas.getContext('2d');
canvas.width = 160;
canvas.height = 60;
ctx.clearRect(0,0,canvas.width, canvas.height);
if(!history || history.length===0) return;
const data = history.map(v => Number(v));
const min = Math.min(...data);
const max = Math.max(...data);
const range = (max - min) || 1;
const pad = 4;
ctx.beginPath();
data.forEach((val,i)=>{
const x = pad + i * ((canvas.width - pad*2)/(data.length-1 || 1));
const y = canvas.height - pad - ((val - min)/range)*(canvas.height - pad*2);
if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
});
ctx.strokeStyle = '#38bdf8';
ctx.lineWidth = 2;
ctx.stroke();
}

function openExpanded(symbol){
expandedSymbolSelected = symbol;
const c = systemState.companies.find(x=>x.symbol===symbol);
expandedSymbol.textContent = c.symbol;
expandedName.textContent = c.name;
expandedPrice.textContent = formatINR(c.price);
expandedChange.textContent = (c.change>=0?'+':'') + c.change.toFixed(2) + " (" + (((c.change)/(c.price - c.change))*100||0).toFixed(2) + "%)";
expandedVol.textContent = "Vol " + c.volume.toLocaleString();
expandedArea.style.display = "block";

buyQtyInput.value = 10;
sellQtyInput.value = 10;

drawExpandedChart(c.history, c.name);

buyBtn.onclick = ()=> buyShares(symbol, Number(buyQtyInput.value||0));
sellBtn.onclick = ()=> sellShares(symbol, Number(sellQtyInput.value||0));
}

function collapseExpanded(){
expandedSymbolSelected = null;
expandedArea.style.display = "none";
if(expandedChart){ expandedChart.destroy(); expandedChart = null; }
}

function drawExpandedChart(history, label){
const ctx = document.getElementById('expandedChart').getContext('2d');
if(expandedChart) expandedChart.destroy();
const data = history.map(v => Number(v));
expandedChart = new Chart(ctx, {
type: 'line',
data: {
labels: data.map((_,i)=>i+1),
datasets: [{
label: label,
data: data,
borderColor: '#0ea5e9',
backgroundColor: 'rgba(14,165,233,0.12)',
fill: true,
tension: 0.25,
pointRadius: 0
}]
},
options: {
responsive: true,
maintainAspectRatio: false,
scales: {
x: { display:false },
y: { beginAtZero:false }
},
plugins: { legend: { display: false } }
}
});
}

/* -------------------------
Market tick
------------------------- */

async function marketTick(){
// Always update prices with 20% chance from any user
// This keeps market moving even without admin
const shouldUpdatePrices = Math.random() < 0.2; // 20% chance any user updates
if(shouldUpdatePrices) {
await updateStockPrices();
} else {
// Fetch latest prices from Supabase
await fetchCurrentPrices();
}

// Update UI based on current user role
if(currentUser) {
if(currentUser.role === 'participant') {
renderHeader();
renderCards();
renderInvestments();

if(expandedSymbolSelected){
const c = systemState.companies.find(x=>x.symbol===expandedSymbolSelected);
if(c){
expandedPrice.textContent = formatINR(c.price);
expandedVol.textContent = "Vol " + c.volume.toLocaleString();
drawExpandedChart(c.history, c.name);
} else {
collapseExpanded();
}
}
}
// Admin has its own refresh cycle via startAdminRefresh()
}
}




/* -------------------------
Buy / Sell logic
------------------------- */

async function buyShares(symbol, qty){
if(!qty || qty<=0){ alert("Enter valid quantity"); return; }
const company = systemState.companies.find(c=>c.symbol===symbol);
if(!company) return;
const cost = company.price * qty;
if(cost > currentUser.data.cash){ alert("Not enough cash"); return; }

// Show confirmation
if(!showBuyConfirmation(symbol, qty, company.price, cost)) {
return;
}

currentUser.data.cash -= cost;

const existing = currentUser.data.investments.find(i=>i.symbol===symbol && i.buyPrice===company.price);
if(existing){
existing.qty += qty;
} else {
currentUser.data.investments.push({ symbol, qty, buyPrice: company.price, buyTime: Date.now() });
}

// PRICE IMPACT: Buying increases price (adds to natural fluctuation)
const priceImpact = qty * 0.000001; // 0.01% per share
const newPrice = company.price * (1 + priceImpact);
company.price = Number(newPrice.toFixed(2));
company.change = newPrice - company.price; // Update change
company.history = [...company.history.slice(1), company.price];

// Update price in Supabase immediately
await supabase
.from('stocks')
.update({ current_price: company.price })
.eq('symbol', symbol);

await syncParticipantData();
renderHeader();
renderCards(); // Refresh to show new price
renderInvestments();
alert("✓ Purchase Successful!\n\nBought " + qty + " shares of " + symbol + "\nAmount Debited: " + formatINR(cost) + "\nRemaining Balance: " + formatINR(currentUser.data.cash));
}

  

async function sellShares(symbol, qty){
if(!qty || qty<=0){ alert("Enter valid quantity"); return; }
let remaining = qty;
let totalProceeds = 0;

// Calculate first
const company = systemState.companies.find(c=>c.symbol===symbol);
const livePrice = company?.price;
if(!livePrice) { alert("Stock not found"); return; }

let canSell = 0;
for(let i = 0; i < currentUser.data.investments.length; i++){
const inv = currentUser.data.investments[i];
if(inv.symbol === symbol) canSell += inv.qty;
}

if(canSell < qty){
alert("You don't hold that many shares to sell.");
return;
}

totalProceeds = livePrice * qty;

// Show confirmation
if(!showSellConfirmation(symbol, qty, livePrice, totalProceeds)) {
return;
}

// Now execute the sale
for(let i = currentUser.data.investments.length-1; i>=0 && remaining>0; i--){
const inv = currentUser.data.investments[i];
if(inv.symbol !== symbol) continue;
const sellQty = Math.min(inv.qty, remaining);
inv.qty -= sellQty;
remaining -= sellQty;
if(inv.qty === 0) currentUser.data.investments.splice(i,1);
}

// PRICE IMPACT: Selling decreases price (adds to natural fluctuation)
const priceImpact = qty * 0.000001; // 0.01% per share
const oldPrice = company.price;
const newPrice = Math.max(15, company.price * (1 - priceImpact)); // Minimum price of 0.01
company.price = Number(newPrice.toFixed(2));
company.change = company.price - oldPrice; // Update change
company.history = [...company.history.slice(1), company.price];

// Update price in Supabase immediately
await supabase
.from('stocks')
.update({ current_price: company.price })
.eq('symbol', symbol);

currentUser.data.cash += totalProceeds;
await syncParticipantData();
renderHeader();
renderCards(); // Refresh to show new price
renderInvestments();
alert("✓ Sale Successful!\n\nSold " + qty + " shares of " + symbol + "\nAmount Credited: " + formatINR(totalProceeds) + "\nNew Balance: " + formatINR(currentUser.data.cash));
}
  
async function sellInvestment(index){
const inv = currentUser.data.investments[index];
if(!inv) return;
const company = systemState.companies.find(c=>c.symbol===inv.symbol);
const live = company ? company.price : inv.buyPrice;
const proceeds = live * inv.qty;
const profitLoss = proceeds - (inv.buyPrice * inv.qty);

// Show confirmation
if(!showSellConfirmation(inv.symbol, inv.qty, live, proceeds)) {
return;
}

// PRICE IMPACT: Selling decreases price (adds to natural fluctuation)
if(company) {
const priceImpact = inv.qty * 0.000001; // 0.01% per share
const oldPrice = company.price;
const newPrice = Math.max(15, company.price * (1 - priceImpact));
company.price = Number(newPrice.toFixed(2));
company.change = company.price - oldPrice; // Update change
company.history = [...company.history.slice(1), company.price];

// Update price in Supabase immediately
await supabase
.from('stocks')
.update({ current_price: company.price })
.eq('symbol', inv.symbol);
}

currentUser.data.investments.splice(index,1);
currentUser.data.cash += proceeds;
await syncParticipantData();
renderHeader();
renderCards(); // Refresh to show new price
renderInvestments();
alert("✓ Sale Successful!\n\n" + (profitLoss>=0 ? '💰 Profit' : '📉 Loss') + ": " + formatINR(Math.abs(profitLoss)) + "\nAmount Credited: " + formatINR(proceeds) + "\nNew Balance: " + formatINR(currentUser.data.cash));
}
  
async function syncParticipantData(){
const pIndex = systemState.participants.findIndex(p => p.username === currentUser.username);
if(pIndex !== -1){
systemState.participants[pIndex] = currentUser.data;
await saveParticipant(currentUser.data);
}
}

/* -------------------------
Confirmation Dialogs
------------------------- */

function showBuyConfirmation(symbol, qty, price, totalCost) {
return confirm(
"CONFIRM PURCHASE\n\n" +
"Stock: " + symbol + "\n" +
"Quantity: " + qty + " shares\n" +
"Price per share: " + formatINR(price) + "\n" +
"Total Amount: " + formatINR(totalCost) + "\n\n" +
formatINR(totalCost) + " will be deducted from your account.\n\n" +
"Do you want to proceed?"
);
}


function showSellConfirmation(symbol, qty, livePrice, totalProceeds) {
return confirm(
"CONFIRM SALE\n\n" +
"Stock: " + symbol + "\n" +
"Quantity: " + qty + " shares\n" +
"Price per share: " + formatINR(livePrice) + "\n" +
"Total Amount: " + formatINR(totalProceeds) + "\n\n" +
formatINR(totalProceeds) + " will be deposited to your account.\n\n" +
"Do you want to proceed?"
);
}

/* -------------------------
Controls
------------------------- */

intervalSelect.addEventListener('change', async (e)=>{
systemState.intervalMs = Number(e.target.value);
await saveSystemConfig();
restartTicker();
});


/* -------------------------
Ticker control
------------------------- */



function startTicker(){
stopTicker();
tickerHandle = setInterval(()=>{ if(systemState.running) marketTick(); }, systemState.intervalMs);
}

function stopTicker(){
if(tickerHandle) { clearInterval(tickerHandle); tickerHandle = null; }
}

function restartTicker(){ startTicker(); }

/* -------------------------
Event Handlers
------------------------- */

document.getElementById('loginBtn').addEventListener('click', async ()=>{
const username = document.getElementById('loginUsername').value.trim();
const password = document.getElementById('loginPassword').value;
const result = await login(username, password);
const errorEl = document.getElementById('loginError');

if(result === true){
errorEl.style.display = 'none';
showMainApp();
} else if(result === 'market_stopped'){
errorEl.textContent = 'Market is currently stopped. Please try again later.';
errorEl.style.display = 'block';
} else {
errorEl.textContent = 'Invalid username or password';
errorEl.style.display = 'block';
}
});

document.getElementById('logoutBtn').addEventListener('click', logout);
document.getElementById('logoutBtnParticipant').addEventListener('click', logout);

document.getElementById('startMarketBtn').addEventListener('click', async ()=>{
await startMarket();
});

document.getElementById('stopMarketBtn').addEventListener('click', async ()=>{
await stopMarket();
});

document.getElementById('addParticipantBtn').addEventListener('click', addParticipant);

document.getElementById('saveParticipantBtn').addEventListener('click', async ()=>{
await saveParticipantHandler();
});

document.getElementById('cancelParticipantBtn').addEventListener('click', ()=>{
document.getElementById('participantModal').classList.remove('active');
});

document.getElementById('addStockBtn').addEventListener('click', addStock);

document.getElementById('saveStockBtn').addEventListener('click', async ()=>{
await saveStockHandler();
});

document.getElementById('cancelStockBtn').addEventListener('click', ()=>{
document.getElementById('stockModal').classList.remove('active');
});

// Make functions global for onclick handlers
window.editParticipant = editParticipant;
window.deleteParticipant = deleteParticipant;
window.editStock = editStock;
window.deleteStock = deleteStock;

/* -------------------------
Initialize
------------------------- */

async function init(){
await loadSystemState();
showLoginScreen();
}

init();

</script>
</body>
</html>



